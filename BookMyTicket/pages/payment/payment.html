<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment and Billing</title>
    <link rel="stylesheet" href="payment.css">
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tablinks" onclick="openTab(event, 'billing')" id="defaultOpen">Billing</button>
            <button class="tablinks" onclick="openTab(event, 'payment')" id="paymentTab">Payment Details</button>
        </div>

        <div id="billing" class="tabcontent">
            <h3>Billing Information</h3>
            <form id="billingForm">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>

                <label for="contact">Contact Number:</label>
                <input type="text" id="contact" name="contact" required>

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>

                <p><strong>Movie Name:</strong> Dummy Movie</p>
                <p><strong>Theatre Name:</strong> Dummy Theatre</p>
                <p><strong>Seats Selected:</strong> <span id="seatsSelected"></span></p>
                <p><strong>Total Price:</strong> Rs <span id="totalPrice"></span></p>

                <button type="button" onclick="submitBilling()">Submit</button>
            </form>
        </div>

        <div id="payment" class="tabcontent">
            <h3>Payment Information</h3>
            <label for="paymentMethod">Payment Method:</label>
            <select id="paymentMethod" onchange="showPaymentForm()">
                <option value="">Select Payment Method</option>
                <option value="card">Credit/Debit Card</option>
                <option value="upi">UPI</option>
            </select>

            <div id="cardDetails" style="display:none;">
                <label for="cardNumber">Card Number:</label>
                <input type="text" id="cardNumber" name="cardNumber" maxlength="16" required>

                <label for="expiryDate">Expiry Date:</label>
                <input type="month" id="expiryDate" name="expiryDate" required>

                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" maxlength="3" required>
            </div>

            <div id="upiDetails" style="display:none;">
                <label for="upiID">UPI ID:</label>
                <input type="text" id="upiID" name="upiID" required>
            </div>

            <button type="button" onclick="confirmBooking()">Pay</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, collection, doc, setDoc} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADRfGEYCRg2bl2Fie01SBnf8Bsi-nePI8",
            authDomain: "movie-ticket-booking-web-2e392.firebaseapp.com",
            projectId: "movie-ticket-booking-web-2e392",
            storageBucket: "movie-ticket-booking-web-2e392.appspot.com",
            messagingSenderId: "155753864309",
            appId: "1:155753864309:web:9ea066e506350ad1266c3c",
            measurementId: "G-T6FYQTXBQ1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Event listeners and functions
        document.addEventListener("DOMContentLoaded", function () {
            const selectedSeats = JSON.parse(sessionStorage.getItem("selectedSeats"));
            const totalPrice = sessionStorage.getItem("totalPrice");

            document.getElementById("seatsSelected").textContent = selectedSeats ? selectedSeats.join(", ") : "No seats selected";
            document.getElementById("totalPrice").textContent = totalPrice || "0";

            document.getElementById("defaultOpen").click();
        });

        window.openTab = function (evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        window.submitBilling = function () {
    var name = document.getElementById('name').value;
    var contact = document.getElementById('contact').value;
    var email = document.getElementById('email').value;

    // Validate the contact number (should be 10 digits)
    if (!/^\d{10}$/.test(contact)) {
        alert("Contact number should be 10 digits.");
        return; // Exit the function if validation fails
    }

    if (name && contact && email) {
        // Save customer details to sessionStorage
        sessionStorage.setItem("customerDetails", JSON.stringify({
            name: name,
            contact: contact,
            email: email
        }));

        // Switch to the payment tab
        document.getElementById("paymentTab").click();
    } else {
        alert("Please fill in all the details.");
    }
}


        window.showPaymentForm = function () {
            var paymentMethod = document.getElementById('paymentMethod').value;

            document.getElementById('cardDetails').style.display = 'none';
            document.getElementById('upiDetails').style.display = 'none';

            if (paymentMethod === 'card') {
                document.getElementById('cardDetails').style.display = 'block';
            } else if (paymentMethod === 'upi') {
                document.getElementById('upiDetails').style.display = 'block';
            }
        }

        

window.confirmBooking = async function () {
    var paymentMethod = document.getElementById('paymentMethod').value;
    var isValid = true;

    if (paymentMethod === 'card') {
        var cardNumber = document.getElementById('cardNumber').value;
        var expiryDate = document.getElementById('expiryDate').value;
        var cvv = document.getElementById('cvv').value;

        if (!/^\d{16}$/.test(cardNumber)) {
            isValid = false;
            alert("Card number should be 16 digits.");
        }

        if (!/^\d{3}$/.test(cvv)) {
            isValid = false;
            alert("CVV should be 3 digits.");
        }

        var currentDate = new Date();
        var expiry = new Date(expiryDate + "-01");

        if (!expiryDate || expiry < currentDate) {
            isValid = false;
            alert("Expiry date is invalid or has passed.");
        }
    } else if (paymentMethod === 'upi') {
        var upiID = document.getElementById('upiID').value;

        if (!upiID) {
            isValid = false;
            alert("UPI ID cannot be empty.");
        }
    } else {
        isValid = false;
        alert("Please select a payment method.");
    }

    if (isValid) {
        const selectedSeats = JSON.parse(sessionStorage.getItem("selectedSeats"));
        const totalPrice = sessionStorage.getItem("totalPrice");
        const theaterName = "Theater1";
        const movieName = "MovieA";
        const showDate = "2024-08-30";
        const showTime = "19:00";

        // Retrieve customer details from sessionStorage
        const customerDetails = JSON.parse(sessionStorage.getItem("customerDetails"));
        const { name, contact, email } = customerDetails;

        const orderId = `ORD-${Date.now()}`;
        const docId = `${theaterName}_${movieName}_${showDate}_${showTime}_${email}`;
        const reservationsRef = collection(db, "Reservations");
        const reservationDocRef = doc(reservationsRef, docId);

        // Prepare the reservation data
        const reservationData = {
            Payment_Status: true,
            startDate: new Date().toISOString(),
            orderId: orderId,
            totalPrice: totalPrice,
            movieId: "dummyMovieId",
            theaterId: "dummyTheaterId",
            username: name,
            contactNo: contact,
            email: email,
            paymentMethod: paymentMethod
        };

        try {
            // Check if the document exists
            const docSnapshot = await getDoc(reservationDocRef);
            if (docSnapshot.exists()) {
                // Document exists, so update the seats
                const existingData = docSnapshot.data();
                const existingSeats = existingData.seats || [];

                // Merge new seats with existing ones
                const updatedSeats = [...new Set([...existingSeats, ...selectedSeats])];

                // Update the document with new seat list
                await updateDoc(reservationDocRef, { seats: updatedSeats, ...reservationData });
            } else {
                // Document does not exist, create a new one
                await setDoc(reservationDocRef, { ...reservationData, seats: selectedSeats });
            }

            alert("Your booking is confirmed, Ticket is sent to your email!!");

            // window.location.href = "confirmation.html";
        } catch (error) {
            console.error("Error creating reservation: ", error);
            alert("There was an error confirming your booking. Please try again.");
        }
    }
}

    </script>
</body>
</html>
